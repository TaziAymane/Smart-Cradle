// Translation dictionaries
const translations = {
    en: {
        page_title: "Real-time Baby Monitoring - Smart Cradle",
        brand_name: "Smart Cradle",
        live_status: "LIVE",
        emergency_btn: "Emergency",
        nav_dashboard: "Dashboard",
        nav_vital_signs: "Vital Signs",
        nav_trends: "Trends",
        nav_alerts: "Alerts",
        nav_history: "History",
        nav_settings: "Settings",
        main_title: "Real-time Baby Monitoring",
        last_updated: "Last updated:",
        status_normal: "All Systems Normal",
        baby_name_label: "Baby Name",
        baby_name: "Emma Johnson",
        baby_age_label: "Age",
        baby_age: "3 months, 2 weeks",
        baby_weight_label: "Weight",
        baby_weight: "5.2 kg",
        sleep_status_label: "Sleep Status",
        sleep_status: "Sleeping (2h 15m)",
        heart_rate_monitor: "Heart Rate Monitor",
        status_normal_badge: "Normal",
        ecg_label: "ECG",
        heart_rate_range: "Normal range: 120-160 BPM",
        temperature_label: "Temperature",
        min_label: "Min:",
        max_label: "Max:",
        breathing_rate_label: "Breathing Rate",
        breaths_per_min: "breaths/min",
        breathing_range: "Normal range: 30-60",
        oxygen_saturation_label: "Oxygen Saturation",
        oxygen_range: "Normal: > 95%",
        status_excellent: "Excellent",
        movement_label: "Movement",
        movement_active: "Active",
        last_movement: "Last movement: 2 min ago",
        normal_activity: "Normal Activity",
        sleep_quality_label: "Sleep Quality",
        deep_sleep: "Deep sleep phase",
        good_quality: "Good Quality",
        environment_label: "Environment",
        room_temp: "Room Temp",
        humidity: "Humidity",
        quiet_status: "Quiet (25 dB)",
        optimal_status: "Optimal",
        trends_chart_title: "24-Hour Vital Signs Trends",
        recent_alerts: "Recent Alerts",
        alert_all_normal: "All Systems Normal",
        alert_monitoring_active: "Continuous monitoring active",
        time_now: "Now",
        alert_temp_rise: "Slight Temperature Rise",
        alert_temp_detected: "37.2°C detected, monitoring closely",
        time_2h_ago: "2h ago",
        alert_sleep_started: "Sleep Cycle Started",
        alert_deep_sleep: "Baby entered deep sleep phase",
        time_2h15m_ago: "2h 15m ago",
        alert_feeding_reminder: "Feeding Time Reminder",
        alert_next_feeding: "Next feeding in 30 minutes",
        time_3h_ago: "3h ago",
        view_all_alerts: "View All Alerts"
    },
    fr: {
        page_title: "Surveillance Bébé en Temps Réel - Smart Cradle",
        brand_name: "Smart Cradle",
        live_status: "EN DIRECT",
        emergency_btn: "Urgence",
        nav_dashboard: "Tableau de Bord",
        nav_vital_signs: "Signes Vitaux",
        nav_trends: "Tendances",
        nav_alerts: "Alertes",
        nav_history: "Historique",
        nav_settings: "Paramètres",
        main_title: "Surveillance Bébé en Temps Réel",
        last_updated: "Dernière mise à jour:",
        status_normal: "Tous les Systèmes Normaux",
        baby_name_label: "Nom du Bébé",
        baby_name: "Emma Johnson",
        baby_age_label: "Âge",
        baby_age: "3 mois, 2 semaines",
        baby_weight_label: "Poids",
        baby_weight: "5,2 kg",
        sleep_status_label: "État du Sommeil",
        sleep_status: "Dort (2h 15m)",
        heart_rate_monitor: "Moniteur de Fréquence Cardiaque",
        status_normal_badge: "Normal",
        ecg_label: "ECG",
        heart_rate_range: "Plage normale: 120-160 BPM",
        temperature_label: "Température",
        min_label: "Min:",
        max_label: "Max:",
        breathing_rate_label: "Fréquence Respiratoire",
        breaths_per_min: "respirations/min",
        breathing_range: "Plage normale: 30-60",
        oxygen_saturation_label: "Saturation en Oxygène",
        oxygen_range: "Normal: > 95%",
        status_excellent: "Excellent",
        movement_label: "Mouvement",
        movement_active: "Actif",
        last_movement: "Dernier mouvement: il y a 2 min",
        normal_activity: "Activité Normale",
        sleep_quality_label: "Qualité du Sommeil",
        deep_sleep: "Phase de sommeil profond",
        good_quality: "Bonne Qualité",
        environment_label: "Environnement",
        room_temp: "Temp. Pièce",
        humidity: "Humidité",
        quiet_status: "Silencieux (25 dB)",
        optimal_status: "Optimal",
        trends_chart_title: "Tendances des Signes Vitaux sur 24h",
        recent_alerts: "Alertes Récentes",
        alert_all_normal: "Tous les Systèmes Normaux",
        alert_monitoring_active: "Surveillance continue active",
        time_now: "Maintenant",
        alert_temp_rise: "Légère Hausse de Température",
        alert_temp_detected: "37,2°C détectée, surveillance étroite",
        time_2h_ago: "Il y a 2h",
        alert_sleep_started: "Cycle de Sommeil Commencé",
        alert_deep_sleep: "Bébé entré en phase de sommeil profond",
        time_2h15m_ago: "Il y a 2h 15m",
        alert_feeding_reminder: "Rappel Heure du Repas",
        alert_next_feeding: "Prochain repas dans 30 minutes",
        time_3h_ago: "Il y a 3h",
        view_all_alerts: "Voir Toutes les Alertes"
    },
    ar: {
        page_title: "مراقبة الطفل في الوقت الفعلي - المهد الذكي",
        brand_name: "المهد الذكي",
        live_status: "مباشر",
        emergency_btn: "طوارئ",
        nav_dashboard: "لوحة التحكم",
        nav_vital_signs: "العلامات الحيوية",
        nav_trends: "الاتجاهات",
        nav_alerts: "التنبيهات",
        nav_history: "التاريخ",
        nav_settings: "الإعدادات",
        main_title: "مراقبة الطفل في الوقت الفعلي",
        last_updated: "آخر تحديث:",
        status_normal: "جميع الأنظمة طبيعية",
        baby_name_label: "اسم الطفل",
        baby_name: "إيما جونسون",
        baby_age_label: "العمر",
        baby_age: "3 أشهر، أسبوعان",
        baby_weight_label: "الوزن",
        baby_weight: "5.2 كيلو",
        sleep_status_label: "حالة النوم",
        sleep_status: "نائم (2س 15د)",
        heart_rate_monitor: "مراقب معدل ضربات القلب",
        status_normal_badge: "طبيعي",
        ecg_label: "تخطيط القلب",
        heart_rate_range: "المعدل الطبيعي: 120-160 نبضة/دقيقة",
        temperature_label: "درجة الحرارة",
        min_label: "الأدنى:",
        max_label: "الأعلى:",
        breathing_rate_label: "معدل التنفس",
        breaths_per_min: "نفس/دقيقة",
        breathing_range: "المعدل الطبيعي: 30-60",
        oxygen_saturation_label: "تشبع الأكسجين",
        oxygen_range: "طبيعي: > 95%",
        status_excellent: "ممتاز",
        movement_label: "الحركة",
        movement_active: "نشط",
        last_movement: "آخر حركة: منذ دقيقتين",
        normal_activity: "نشاط طبيعي",
        sleep_quality_label: "جودة النوم",
        deep_sleep: "مرحلة النوم العميق",
        good_quality: "جودة جيدة",
        environment_label: "البيئة",
        room_temp: "حرارة الغرفة",
        humidity: "الرطوبة",
        quiet_status: "هادئ (25 ديسيبل)",
        optimal_status: "مثالي",
        trends_chart_title: "اتجاهات العلامات الحيوية لـ 24 ساعة",
        recent_alerts: "التنبيهات الأخيرة",
        alert_all_normal: "جميع الأنظمة طبيعية",
        alert_monitoring_active: "المراقبة المستمرة نشطة",
        time_now: "الآن",
        alert_temp_rise: "ارتفاع طفيف في درجة الحرارة",
        alert_temp_detected: "تم اكتشاف 37.2°م، مراقبة دقيقة",
        time_2h_ago: "منذ ساعتين",
        alert_sleep_started: "بدأت دورة النوم",
        alert_deep_sleep: "دخل الطفل في مرحلة النوم العميق",
        time_2h15m_ago: "منذ ساعتين و15 دقيقة",
        alert_feeding_reminder: "تذكير وقت الرضاعة",
        alert_next_feeding: "الرضاعة التالية خلال 30 دقيقة",
        time_3h_ago: "منذ 3 ساعات",
        view_all_alerts: "عرض جميع التنبيهات"
    }
};

// Global variables
let currentLang = localStorage.getItem('language') || 'en';
let heartRateData = [];
let temperatureData = [];
let breathingData = [];
let currentTime = new Date();
let trendsChart;
let ecgCanvas;
let ecgCtx;
let ecgX = 0;

// Language change function
function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    
    // Update HTML attributes
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    
    // Update all translatable elements
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
        }
    });
    
    // Update language selector
    const languageNames = {
        'en': 'English',
        'fr': 'Français',
        'ar': 'العربية'
    };
    
    document.getElementById('currentLanguage').textContent = languageNames[lang];
    document.getElementById('currentFlag').className = `language-flag flag-${lang}`;
    
    // Update chart labels if chart exists
    if (typeof trendsChart !== 'undefined') {
        updateChartLabels(lang);
    }
}

// Update chart labels
function updateChartLabels(lang) {
    const chartLabels = {
        en: {
            heartRate: 'Heart Rate (BPM)',
            temperature: 'Temperature (°C)',
            breathing: 'Breathing Rate',
            oxygen: 'Oxygen Sat (%)',
            timeLabel: 'Time (Hours)',
            bpmLabel: 'BPM / Breaths per min'
        },
        fr: {
            heartRate: 'Fréquence Cardiaque (BPM)',
            temperature: 'Température (°C)',
            breathing: 'Fréquence Respiratoire',
            oxygen: 'Saturation O2 (%)',
            timeLabel: 'Temps (Heures)',
            bpmLabel: 'BPM / Respirations par min'
        },
        ar: {
            heartRate: 'معدل ضربات القلب (نبضة/دقيقة)',
            temperature: 'درجة الحرارة (°م)',
            breathing: 'معدل التنفس',
            oxygen: 'تشبع الأكسجين (%)',
            timeLabel: 'الوقت (ساعات)',
            bpmLabel: 'نبضة/دقيقة / أنفاس في الدقيقة'
        }
    };

    if (trendsChart && chartLabels[lang]) {
        trendsChart.data.datasets[0].label = chartLabels[lang].heartRate;
        trendsChart.data.datasets[1].label = chartLabels[lang].temperature;
        trendsChart.data.datasets[2].label = chartLabels[lang].breathing;
        trendsChart.data.datasets[3].label = chartLabels[lang].oxygen;
        
        trendsChart.options.scales.x.title.text = chartLabels[lang].timeLabel;
        trendsChart.options.scales.y.title.text = chartLabels[lang].bpmLabel;
        
        trendsChart.update();
    }
}

// ECG Animation
function drawECG() {
    ecgCtx.clearRect(0, 0, ecgCanvas.width, ecgCanvas.height);
    ecgCtx.strokeStyle = '#27AE60';
    ecgCtx.lineWidth = 2;
    ecgCtx.beginPath();
    
    const centerY = ecgCanvas.height / 2;
    const amplitude = 40;
    
    for (let x = 0; x < ecgCanvas.width; x++) {
        let y = centerY;
        
        // Create ECG pattern
        const phase = (x + ecgX) % 100;
        if (phase < 10) {
            y = centerY;
        } else if (phase < 15) {
            y = centerY - amplitude * 0.3;
        } else if (phase < 20) {
            y = centerY + amplitude;
        } else if (phase < 25) {
            y = centerY - amplitude * 1.5;
        } else if (phase < 30) {
            y = centerY + amplitude * 0.5;
        } else if (phase < 35) {
            y = centerY - amplitude * 0.2;
        } else {
            y = centerY;
        }
        
        if (x === 0) {
            ecgCtx.moveTo(x, y);
        } else {
            ecgCtx.lineTo(x, y);
        }
    }
    
    ecgCtx.stroke();
    ecgX += 2;
    requestAnimationFrame(drawECG);
}

// Generate sample data for the last 24 hours
function generateSampleData() {
    const data = [];
    const labels = [];
    const now = new Date();
    
    for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 60 * 60 * 1000);
        labels.push(time.getHours() + ':00');
        
        data.push({
            heartRate: 120 + Math.random() * 20 + Math.sin(i * 0.5) * 10,
            temperature: 36.5 + Math.random() * 0.8,
            breathing: 35 + Math.random() * 15,
            oxygen: 96 + Math.random() * 3
        });
    }
    
    return { labels, data };
}

// Initialize trends chart
function initializeTrendsChart() {
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    const sampleData = generateSampleData();
    
    trendsChart = new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: sampleData.labels,
            datasets: [
                {
                    label: 'Heart Rate (BPM)',
                    data: sampleData.data.map(d => d.heartRate),
                    borderColor: '#E74C3C',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Temperature (°C)',
                    data: sampleData.data.map(d => d.temperature),
                    borderColor: '#F39C12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                },
                {
                    label: 'Breathing Rate',
                    data: sampleData.data.map(d => d.breathing),
                    borderColor: '#3498DB',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Oxygen Sat (%)',
                    data: sampleData.data.map(d => d.oxygen),
                    borderColor: '#9B59B6',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y2'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time (Hours)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'BPM / Breaths per min'
                    },
                    min: 0,
                    max: 180
                },
                y1: {
                    type: 'linear',
                    display: false,
                    position: 'right',
                    min: 35,
                    max: 39,
                    grid: {
                        drawOnChartArea: false,
                    },
                },
                y2: {
                    type: 'linear',
                    display: false,
                    position: 'right',
                    min: 90,
                    max: 100,
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            }
        }
    });
}

// Real-time data updates
function updateVitalSigns() {
    // Simulate real-time data changes
    const heartRate = 120 + Math.random() * 20 + Math.sin(Date.now() / 10000) * 15;
    const temperature = 36.5 + Math.random() * 0.6;
    const breathing = 35 + Math.random() * 15;
    const oxygen = 96 + Math.random() * 3;

    // Update display values
    document.getElementById('heartRate').textContent = Math.round(heartRate) + ' BPM';
    document.getElementById('temperature').textContent = temperature.toFixed(1);
    document.getElementById('breathingRate').textContent = Math.round(breathing);
    document.getElementById('oxygenSat').textContent = Math.round(oxygen);

    // Update last update time
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

// Initialize ECG Canvas
function initializeECG() {
    ecgCanvas = document.getElementById('ecgCanvas');
    ecgCtx = ecgCanvas.getContext('2d');
    ecgCanvas.width = ecgCanvas.offsetWidth;
    ecgCanvas.height = ecgCanvas.offsetHeight;
    drawECG();
}

// Event Listeners
function initializeEventListeners() {
    // Emergency button functionality
    document.querySelector('.emergency-btn').addEventListener('click', function() {
        const confirmMessages = {
            en: 'Are you sure you want to trigger an emergency alert? This will notify medical staff immediately.',
            fr: 'Êtes-vous sûr de vouloir déclencher une alerte d\'urgence? Cela notifiera immédiatement le personnel médical.',
            ar: 'هل أنت متأكد من أنك تريد تشغيل تنبيه الطوارئ؟ سيؤدي هذا إلى إشعار الطاقم الطبي فوراً.'
        };
        
        const alertMessages = {
            en: 'Emergency alert sent! Medical staff have been notified.',
            fr: 'Alerte d\'urgence envoyée! Le personnel médical a été notifié.',
            ar: 'تم إرسال تنبيه الطوارئ! تم إشعار الطاقم الطبي.'
        };
        
        if (confirm(confirmMessages[currentLang])) {
            alert(alertMessages[currentLang]);
        }
    });

    // Sidebar navigation
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// Update chart data periodically
function startChartUpdates() {
    setInterval(() => {
        const now = new Date();
        const newLabel = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
        
        // Add new data point
        trendsChart.data.labels.push(newLabel);
        trendsChart.data.datasets[0].data.push(120 + Math.random() * 20);
        trendsChart.data.datasets[1].data.push(36.5 + Math.random() * 0.8);
        trendsChart.data.datasets[2].data.push(35 + Math.random() * 15);
        trendsChart.data.datasets[3].data.push(96 + Math.random() * 3);
        
        // Remove old data point if more than 24 points
        if (trendsChart.data.labels.length > 24) {
            trendsChart.data.labels.shift();
            trendsChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        trendsChart.update('none');
    }, 30000);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize components
    initializeECG();
    initializeTrendsChart();
    initializeEventListeners();
    
    // Apply saved language
    changeLanguage(currentLang);
    
    // Start real-time updates
    updateVitalSigns();
    setInterval(updateVitalSigns, 2000);
    
    // Start chart updates
    startChartUpdates();
});

// Handle window resize for ECG canvas
window.addEventListener('resize', function() {
    if (ecgCanvas) {
        ecgCanvas.width = ecgCanvas.offsetWidth;
        ecgCanvas.height = ecgCanvas.offsetHeight;
    }
});